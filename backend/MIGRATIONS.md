# Database Migrations Guide

This document provides detailed instructions for managing database migrations in SubTrack.

## Overview

SubTrack uses **Alembic** for database schema migrations. This is essential for production deployments because:

- ✅ Railway Postgres databases don't auto-create tables
- ✅ Migrations provide version control for database schema
- ✅ Enables safe schema changes across environments
- ✅ Supports rollback if needed

## Initial Migration

The initial migration (`9c457e853f0a`) creates:
- **users** table with all fields including `default_reminder_days_before`
- **subscriptions** table with all fields including:
  - `reminder_enabled`
  - `reminder_days_before`
  - `last_reminder_sent_at`

## Local Development

### Setup

1. **Activate virtual environment:**
   ```bash
   cd backend
   source venv/bin/activate  # or venv\Scripts\activate on Windows
   ```

2. **Apply initial migration:**
   ```bash
   alembic upgrade head
   ```

   This creates all tables in your local SQLite database.

### Creating New Migrations

After modifying models in `app/models/`:

1. **Generate migration:**
   ```bash
   alembic revision --autogenerate -m "Add new field to User model"
   ```

2. **Review the generated file:**
   - Check `alembic/versions/` for the new migration
   - Verify the changes are correct
   - Edit if needed (Alembic sometimes misses things)

3. **Apply migration:**
   ```bash
   alembic upgrade head
   ```

### Common Commands

```bash
# Apply all pending migrations
alembic upgrade head

# Apply up to a specific revision
alembic upgrade <revision_id>

# Rollback one migration
alembic downgrade -1

# Rollback to a specific revision
alembic downgrade <revision_id>

# View migration history
alembic history

# View current migration version
alembic current

# Show SQL that would be executed (without running it)
alembic upgrade head --sql
```

## Production (Railway)

### Automatic Migrations

Migrations run automatically on every deployment via the `Procfile`:

```procfile
web: alembic upgrade head && uvicorn app.main:app --host 0.0.0.0 --port $PORT
```

This ensures:
- ✅ Database schema is always up-to-date
- ✅ No manual intervention needed
- ✅ Migrations run before the server starts

### Manual Migration (If Needed)

If you need to run migrations manually:

1. **Install Railway CLI:**
   ```bash
   npm install -g @railway/cli
   ```

2. **Login and link project:**
   ```bash
   railway login
   railway link
   ```

3. **Run migrations:**
   ```bash
   railway run alembic upgrade head
   ```

4. **Check status:**
   ```bash
   railway run alembic current
   railway run alembic history
   ```

### Troubleshooting

**Migration fails on Railway:**
- Check Railway logs: `railway logs`
- Verify `DATABASE_URL` is set correctly
- Ensure PostgreSQL service is running
- Try manual migration: `railway run alembic upgrade head`

**Tables not created:**
- Verify migrations ran: `railway run alembic current`
- Check if initial migration exists: `railway run alembic history`
- Manually run: `railway run alembic upgrade head`

**Migration conflicts:**
- Never edit existing migrations that have been applied
- Create a new migration to fix issues
- Test locally first

## Migration Best Practices

1. ✅ **Always test locally first** before deploying
2. ✅ **Review autogenerated migrations** - Alembic isn't perfect
3. ✅ **Use descriptive migration messages** - Future you will thank you
4. ✅ **Never edit applied migrations** - Create new ones instead
5. ✅ **Backup production database** before major migrations
6. ✅ **Run migrations in a transaction** (Alembic does this by default)

## Migration File Structure

Each migration file in `alembic/versions/` contains:

- `revision` - Unique identifier
- `down_revision` - Parent migration (creates chain)
- `upgrade()` - Function that applies the migration
- `downgrade()` - Function that rolls back the migration

Example:
```python
def upgrade() -> None:
    op.create_table('users', ...)
    op.create_index(...)

def downgrade() -> None:
    op.drop_index(...)
    op.drop_table('users')
```

## Environment-Specific Notes

### SQLite (Local Dev)
- Migrations work the same way
- SQLite doesn't support all Postgres features
- Test with Postgres locally if using Postgres-specific features

### PostgreSQL (Production)
- Full feature support
- Better performance
- Requires `psycopg2-binary` (already in requirements.txt)

## Quick Reference

| Task | Command |
|------|---------|
| Apply migrations | `alembic upgrade head` |
| Create migration | `alembic revision --autogenerate -m "message"` |
| Rollback | `alembic downgrade -1` |
| View history | `alembic history` |
| Current version | `alembic current` |
| Railway manual | `railway run alembic upgrade head` |

